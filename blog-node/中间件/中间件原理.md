---
title: 中间件原理
date: 2020-5-12
tags:
  - 中间件原理
  - Node
  - Express
  - Koa
categories:
  - [Node, 中间件原理]
---

[TOC]

1. 核心就是 use 来注册事件，通过调用 next 来执行事件，区别执行的方法，执行的同步还是异步事件。
   1. 递归的形式实现中间件，express，单向，自外向内；
   2. 使用 promise 的中间件实现，Koa2，洋葱型（自外向内，后自内向外（next后的也会执行））。
2. 本质上是一个**订阅发布模式**；
3. **中间参数**通过 req 对象传递；

## 中间件是什么

1. Middleware，中间件就是一种**功能的封装方式**。
2. 中间件是在**管道**中执行。
3. 中间件的行为**比较类似 Java 中过滤器的工作原理**，就是在进入具体的业务处理之前，先让过滤器处理。
4. 中间件的**本质就是一个函数**，在收到请求和返回相应的过程中做一些我们想做的事情。
5. 通常在一次 Http 请求通常包含很多工作，
   1. 如记录日志、
   2. ip 过滤、
   3. 查询字符串、
   4. 请求体解析、
   5. Cookie 处理、
   6. 权限验证、
   7. 参数验证、
   8. 异常处理等，
   9. 但对于 Web 应用而言，**并不希望接触到这么多细节性的处理**，因此**引入中间件来简化和隔离这些基础设施与业务逻辑之间的细节**，让开发者能够关注在业务的开发上，以达到提升开发效率的目的。
6. 中间件有一个**next()函数**，如果不调用 next 函数，请求就在这个中间件中终止了。

通常 Node 环境下，一般会常涉及到：

1. Node 中间件；
2. express 中间件；
3. Koa 中间件。

## 方式一，递归的形式实现中间件 ｜ express

1. 将**后续中间件**的执行方法传递给当前中间件，
2. 在当前中间件执行结束，通过**调用 next()方法执行后续中间件的调用**。
3. 在 express 框架中，中间件的实现方式为方式一，**并且全局中间件和内置路由中间件中根据请求路径定义的中间件共同作用**，不过无法在业务处理结束后再调用当前中间件中的代码。

[同步](./Node中间件/moddleware-sync.js)
[异步](./Node中间件/moddleware-async.js)

## 方式 2，使用 promise 的中间件实现 ｜ Koa2

1. 有些中间件不止需要在业务处理前执行，**还需要在业务处理后执行**，比如统计时间的日志中间件。
2. 因此可以将 next()方法的**后续操作封装成一个 Promise 对象**，中间件内部就可以使用 **next.then()形式完成业务处理结束后的回调**。
3. koa2 框架中中间件的实现方式为方式二，**将 next()方法返回值封装成一个 Promise，便于后续中间件的异步流程控制**，实现了 koa2 框架提出的洋葱圈模型，即每一层中间件相当于一个球面，当贯穿整个模型时，实际上每一个球面会穿透两次。
4. koa2 的中间件都实现了`async...await`。

[promise](./Node中间件/moddleware-promise.js)

[可以查看一下 koa-bodyparser 的实现](https://github.com/koajs/bodyparser/blob/master/index.js)

## 核心的接口 use 和 next 的实现

1. use 用来注册/收集中间件；
2. next 用来调用中间件；

## 参考文章

1. [koa2 中间件原理剖析](https://www.jianshu.com/p/2a11705b5de2)
2. [NodeJS 中间件机制学习](https://www.jianshu.com/p/81b6ebc0dd85)
